{% extends "base.html" %}
{% block content %}
<style>
  /* Chat theme (matches black / bright-red / white project) */
  .opi-card { background: #0b0b0b; border: 1px solid rgba(255,23,68,.12); }
  .opi-header { background: linear-gradient(90deg,#FF1744 0%, #b71c31 100%); color: #fff; }
  .chat-window { height:60vh; overflow-y:auto; background:#080808; padding:1rem; border-radius:.375rem; border:1px solid rgba(255,23,68,.08); }
  .msg { display:flex; gap:.75rem; margin-bottom:.75rem; align-items:flex-end; }
  .msg .bubble { max-width:78%; padding:.6rem .9rem; border-radius:14px; line-height:1.25; box-shadow: 0 3px 10px rgba(0,0,0,.4); }
  .msg.user { justify-content:flex-end; }
  .msg.user .bubble { background: linear-gradient(90deg,#FF1744,#c21833); color:#fff; border-bottom-right:4px; text-align:right; }
  .msg.opi { justify-content:flex-start; }
  .msg.opi .bubble { background:#111; color:#fff; border:1px solid rgba(255,23,68,.08); }
  .meta { font-size:.8rem; color:#cfd8dc; opacity:.9; margin-top:.25rem; }
  .typing { display:inline-block; height:10px; width:44px; }
  .typing span { display:inline-block; width:8px; height:8px; margin:0 2px; background:#999; border-radius:50%; animation:blink 1s infinite; opacity:.9; }
  .typing span:nth-child(2){ animation-delay:.15s }
  .typing span:nth-child(3){ animation-delay:.3s }

  @keyframes blink { 0%{opacity:.2}50%{opacity:1}100%{opacity:.2} }

  .chip { display:inline-block; padding:.35rem .6rem; border-radius:999px; background:transparent; color:#fff; border:1px solid rgba(255,23,68,.18); cursor:pointer; margin:.15rem; }
  .chip:hover{ background:rgba(255,23,68,.06) }
  .input-area .form-control { background:#0b0b0b; color:#fff; border:1px solid rgba(255,23,68,.12); }
  .input-area .btn-danger { background:#FF1744; border-color:#FF1744; }
  .small-muted { color: #cfd8dc; opacity:.8; font-size:.9rem; }
</style>

<div class="container mt-4">
  <div class="row justify-content-center">
    <div class="col-md-9">
      <div class="card opi-card shadow-lg">
        <div class="card-header opi-header d-flex justify-content-between align-items-center">
          <div>
            <h5 class="mb-0"><i class="fas fa-robot me-2"></i> Opi — Ask about site news</h5>
            <small class="small-muted">Contextual answers from site articles</small>
          </div>
          <div class="text-end">
            <span class="badge bg-dark text-bright-red border border-bright-red">Contextual AI</span>
            <small class="ms-2 small-muted">Model: Site-only</small>
          </div>
        </div>

        <div class="card-body">
          <div id="opi-chat-window" class="chat-window" role="log" aria-live="polite">
            {% if recent %}
              {% for msg in recent %}
                <div class="msg user">
                  <div class="bubble">
                    <div class="fw-bold small-muted">You</div>
                    <div class="mt-1 text-white-50">{{ msg.question }}</div>
                    <div class="meta text-white-50">{{ msg.created_at|date:"M d, Y H:i" }}</div>
                  </div>
                </div>

                <div class="msg opi">
                  <div class="bubble">
                    <div class="fw-bold text-bright-red">Opi</div>
                    <div class="mt-1 text-white">{{ msg.answer }}</div>
                    {% if msg.used_articles %}
                      <div class="meta">Context: {{ msg.used_articles|join:", " }}</div>
                    {% endif %}
                  </div>
                </div>
              {% endfor %}
            {% else %}
              <div class="text-white-50">Welcome — ask Opi anything related to articles on this site. Try quick prompts below.</div>
            {% endif %}
          </div>

          <div class="mt-3">
            <div class="d-flex flex-wrap align-items-center">
              <!-- quick prompt chips -->
              <div id="quick-chips" class="me-2">
                <button type="button" class="chip" data-q="Show latest technology articles">Latest technology</button>
                <button type="button" class="chip" data-q="Summarize the article about climate change">Summarize climate piece</button>
                <button type="button" class="chip" data-q="Which articles mention the election?">Election mentions</button>
              </div>
              <small class="small-muted ms-auto">Press Enter to send · Shift+Enter for newline</small>
            </div>
          </div>
        </div>

        <div class="card-footer bg-black border-top border-bright-red">
          <form id="opi-form" class="input-area" onsubmit="return false;">
            <div class="input-group">
              <textarea id="opi-question" name="question" class="form-control " placeholder="Ask Opi about site news..." rows="1" required aria-label="Ask Opi"></textarea>
              <button type="submit" id="opi-send" class="btn btn-danger">Ask</button>
            </div>
            <div class="form-text text-white-50 mt-2">Opi uses site articles as primary context. If none match, Opi falls back to general knowledge.</div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // CSRF helper
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(";");
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + "=")) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  const csrftoken = getCookie('csrftoken');

  const chatWindow = document.getElementById('opi-chat-window');
  const input = document.getElementById('opi-question');
  const form = document.getElementById('opi-form');
  const sendBtn = document.getElementById('opi-send');
  const quickChips = document.getElementById('quick-chips');

  function scrollToBottom() { chatWindow.scrollTop = chatWindow.scrollHeight; }

  function createMessageBlock(who, text, meta) {
    const wrap = document.createElement('div');
    wrap.className = 'msg ' + (who === 'user' ? 'user' : 'opi');
    const bubble = document.createElement('div');
    bubble.className = 'bubble';
    const title = document.createElement('div');
    title.className = who === 'user' ? 'fw-bold small-muted' : 'fw-bold text-bright-red';
    title.textContent = who === 'user' ? 'You' : 'Opi';
    const body = document.createElement('div');
    body.className = who === 'user' ? 'mt-1 text-white-50' : 'mt-1 text-white';
    body.innerHTML = text;
    bubble.appendChild(title);
    bubble.appendChild(body);
    if (meta) {
      const m = document.createElement('div');
      m.className = 'meta text-white-50';
      m.innerHTML = meta;
      bubble.appendChild(m);
    }
    wrap.appendChild(bubble);
    return wrap;
  }

  function appendTyping() {
    const wrapper = document.createElement('div');
    wrapper.className = 'msg opi typing-wrapper';
    wrapper.id = 'opi-typing';
    const bubble = document.createElement('div');
    bubble.className = 'bubble';
    bubble.innerHTML = '<div class="fw-bold text-bright-red">Opi</div><div class="typing mt-2"><span></span><span></span><span></span></div>';
    wrapper.appendChild(bubble);
    chatWindow.appendChild(wrapper);
    scrollToBottom();
  }

  function removeTyping() {
    const t = document.getElementById('opi-typing');
    if (t) t.parentElement.removeChild(t);
  }

  async function sendQuestion(question) {
    if (!question) return;
    sendBtn.disabled = true;
    // append user message
    chatWindow.appendChild(createMessageBlock('user', question, new Date().toLocaleString()));
    scrollToBottom();
    input.value = '';
    appendTyping();

    try {
      const res = await fetch("{% url 'opi_chat_api' %}", {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
        body: JSON.stringify({ question })
      });
      const data = await res.json();
      removeTyping();

      if (data.error) {
        chatWindow.appendChild(createMessageBlock('opi', 'Error: ' + data.error, null));
      } else {
        chatWindow.appendChild(createMessageBlock('opi', data.answer, data.used_articles && data.used_articles.length ? ('Context: ' + data.used_articles.join(', ')) : null));
      }
    } catch (err) {
      removeTyping();
      chatWindow.appendChild(createMessageBlock('opi', 'Network or server error.', null));
    } finally {
      sendBtn.disabled = false;
      scrollToBottom();
    }
  }

  form.addEventListener('submit', function (e) {
    e.preventDefault();
    const q = input.value.trim();
    if (!q) return;
    sendQuestion(q);
  });

  // send on Enter (Shift+Enter for newline)
  input.addEventListener('keydown', function (e) {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      form.requestSubmit();
    }
  });

  // quick chips click
  quickChips.addEventListener('click', function (e) {
    const btn = e.target.closest('.chip');
    if (!btn) return;
    const q = btn.getAttribute('data-q');
    if (q) sendQuestion(q);
  });

  // ensure chat autoscroll on load
  window.addEventListener('load', function () { scrollToBottom(); });
</script>
{% endblock %}
